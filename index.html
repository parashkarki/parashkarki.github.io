<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced Shopping Tracker ‚Äî Smart Finance Assistant</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    :root{
      --safe-bottom: 72px; /* bottom nav + breathing */
      --fab-gap: 16px;
      --fab-size: 56px;
    }
    *{outline:none}
    body{font-family:'Inter',sans-serif;background:#f8f8f8;height:100vh;overscroll-behavior:none}
    .custom-scrollbar::-webkit-scrollbar{width:4px}
    .custom-scrollbar::-webkit-scrollbar-thumb{background:#a8a8a8;border-radius:2px}
    .custom-scrollbar::-webkit-scrollbar-track{background:#f1f1f1}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .animate-fadeInUp{animation:fadeInUp .35s ease-out}

    .overlay{position:fixed;inset:0;background:#fff;transform:translateY(100%);transition:transform .28s ease-out;z-index:120}
    .overlay.active{transform:translateY(0)}
    nav.app-bottom{position:sticky;bottom:0;background:#fff;border-top:1px solid #e5e7eb;padding:6px;z-index:60}

    /* Wallet card */
    .wallet-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:16px;color:#fff;padding:20px;box-shadow:0 10px 24px rgba(0,0,0,.10)}
    .budget-progress{height:8px;border-radius:4px;background:rgba(255,255,255,.24);overflow:hidden}
    .budget-progress-fill{height:100%;border-radius:4px;transition:width .5s ease}
    .goal-progress{height:8px;border-radius:4px;background:#e5e7eb;overflow:hidden}
    .goal-progress-fill{height:100%;border-radius:4px;background:#22c55e;transition:width .5s ease}

    /* FABs */
    .fab{position:fixed;right:16px;width:var(--fab-size);height:var(--fab-size);border-radius:50%;
      display:flex;align-items:center;justify-content:center;box-shadow:0 12px 28px rgba(0,0,0,.25);z-index:80}
    #money-tracker-fab{bottom:calc(var(--safe-bottom) + var(--fab-gap));}
    #chatbot-toggle{bottom:calc(var(--safe-bottom) + var(--fab-gap));}

    /* Chat overlay */
    #chatbot-overlay{position:fixed;inset:0;z-index:140;display:none;flex-direction:column;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    .chat-header{backdrop-filter:blur(16px);background:rgba(255,255,255,.14);border-bottom:1px solid rgba(255,255,255,.22);color:#fff}
    .chat-pane{background:rgba(255,255,255,.12)}
    .bubble{padding:10px 14px;border-radius:16px;max-width:78%;box-shadow:0 4px 12px rgba(0,0,0,.14)}
    .bubble.bot{background:rgba(255,255,255,.12);color:#fff;border-bottom-left-radius:4px;border:1px solid rgba(255,255,255,.18)}
    .bubble.me{background:#fff;color:#333;border-bottom-right-radius:4px}
    .typing span{display:inline-block;width:8px;height:8px;margin:0 2px;background:#fff;border-radius:50%;opacity:.6;animation:ty 1.2s infinite ease-in-out}
    .typing span:nth-child(2){animation-delay:.2s}.typing span:nth-child(3){animation-delay:.4s}
    @keyframes ty{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}

    /* Modals on top of overlays */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:200}
    .modal.flex{display:flex}
    .drawer{position:fixed;inset:0;z-index:130;pointer-events:none}
    .drawer .panel{pointer-events:auto;position:absolute;inset:0 0 0 auto;width:85%;max-width:320px;background:#fff;transform:translateX(100%);transition:transform .25s ease;box-shadow:-12px 0 24px rgba(0,0,0,.15)}
    .drawer.active .panel{transform:none}
    .drawer .scrim{position:absolute;inset:0;background:rgba(0,0,0,.4);opacity:0;transition:opacity .25s ease}
    .drawer.active .scrim{opacity:1}
  </style>
</head>

<body class="flex justify-center items-center p-0 sm:p-4">
  <div id="app" class="w-full max-w-sm h-[100vh] flex flex-col bg-white shadow-2xl rounded-none sm:rounded-3xl overflow-hidden relative">

    <!-- Header -->
    <header class="p-4 bg-indigo-600 text-white shadow-lg sticky top-0 z-10 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <button id="menu-button" class="p-2 rounded-full hover:bg-indigo-700"><i class="fas fa-bars"></i></button>
        <h1 id="app-title" class="text-xl font-extrabold">Shopping Tracker</h1>
      </div>
      <div class="flex items-center gap-2">
        <input id="search-input" class="hidden bg-indigo-700 text-white p-2 rounded-lg text-sm focus:ring-2 w-36 placeholder-indigo-200" placeholder="Search item..."/>
        <button id="expense-share-btn" title="ExpenseShare Pro" class="hidden p-2 rounded-full hover:bg-indigo-700"><i class="fas fa-users"></i></button>
        <button id="search-toggle-btn" class="p-2 rounded-full hover:bg-indigo-700"><i class="fas fa-search"></i></button>
        <button id="profile-button" class="p-2 rounded-full hover:bg-indigo-700">
          <div class="w-8 h-8 bg-indigo-100 rounded-full grid place-items-center overflow-hidden">
            <img id="profile-pic-small-img" class="hidden w-full h-full object-cover" alt=""/>
            <i id="profile-icon-small" class="fas fa-user text-indigo-600 text-sm"></i>
          </div>
        </button>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1 overflow-y-auto custom-scrollbar p-4 relative">
      <!-- Dashboard -->
      <section id="dashboard-section" class="page-section space-y-6 animate-fadeInUp">
        <h2 class="text-lg font-bold text-gray-800">Quick Add Item</h2>
        <div class="bg-white p-6 rounded-xl shadow-lg space-y-4">
          <input id="item-name-input" class="w-full p-4 border-2 border-indigo-200 rounded-xl focus:ring-indigo-500" placeholder="Enter item name here..."/>
          <button id="add-item-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-xl text-lg font-bold shadow-indigo-400 shadow">
            <i class="fas fa-plus mr-2"></i> Add to Cart
          </button>
        </div>

        <!-- Home Quick Tiles -->
        <div class="grid grid-cols-2 gap-3">
          <button id="tile-expenseshare" class="p-4 rounded-xl bg-indigo-50 text-indigo-700 font-semibold flex items-center justify-center gap-2"><i class="fas fa-users"></i> ExpenseShare</button>
          <button id="tile-wallet" class="p-4 rounded-xl bg-green-50 text-green-700 font-semibold flex items-center justify-center gap-2"><i class="fas fa-wallet"></i> Wallet</button>
          <button id="tile-journal" class="p-4 rounded-xl bg-pink-50 text-pink-700 font-semibold flex items-center justify-center gap-2"><i class="fas fa-book"></i> Journal</button>
          <button id="tile-todo" class="p-4 rounded-xl bg-amber-50 text-amber-700 font-semibold flex items-center justify-center gap-2"><i class="fas fa-list-check"></i> To-Do</button>
        </div>

        <!-- Today vs Average + Finance Tip -->
        <div class="grid grid-cols-1 gap-3">
          <div class="bg-white rounded-xl shadow p-4">
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold text-gray-700">Today vs Average</p>
              <span id="today-vs-avg-badge" class="text-xs px-2 py-1 rounded-full bg-indigo-50 text-indigo-700">‚Äî</span>
            </div>
            <p id="today-vs-avg-text" class="text-sm text-gray-600 mt-2">We‚Äôll analyze your spending once you add some purchases.</p>
          </div>
          <div class="bg-white rounded-xl shadow p-4">
            <p class="text-sm font-semibold text-gray-700">Finance Tip of the Day</p>
            <p id="finance-tip" class="text-sm text-gray-600 mt-2"></p>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="bg-indigo-50 p-4 rounded-xl text-center">
            <p class="text-sm text-indigo-600 font-medium">Cart Items</p>
            <p id="dashboard-cart-count" class="text-2xl font-bold text-indigo-700">0</p>
          </div>
          <div class="bg-green-50 p-4 rounded-xl text-center">
            <p class="text-sm text-green-600 font-medium">Total Spent</p>
            <p id="dashboard-total-spent" class="text-2xl font-bold text-green-700">$0</p>
          </div>
        </div>
        <div class="text-xs text-center p-2 bg-green-50 text-green-700 rounded-lg"><i class="fas fa-plug mr-1"></i> Data saved locally (Offline mode)</div>
      </section>

      <!-- Cart -->
      <section id="cart-section" class="page-section hidden space-y-4">
        <h2 class="text-lg font-bold text-gray-800">Things to Buy (<span id="cart-count">0</span>)</h2>
        <ul id="cart-list" class="space-y-3"></ul>
        <div id="cart-empty" class="hidden text-center text-gray-500 italic p-6 border-2 border-dashed border-indigo-200 rounded-xl">
          <i class="fas fa-shopping-basket text-2xl mb-2"></i><p>Cart is empty. Time to add some items!</p>
        </div>
      </section>

      <!-- History -->
      <section id="history-section" class="page-section hidden space-y-4">
        <div class="flex justify-between items-center">
          <h2 class="text-lg font-bold text-gray-800">Purchase History</h2>
          <button id="history-filter-btn" class="p-2 rounded-full hover:bg-indigo-50 text-indigo-600"><i class="fas fa-filter"></i></button>
        </div>
        <div id="store-filters" class="hidden flex-wrap gap-2 mb-2">
          <button class="store-filter-btn bg-indigo-600 text-white px-3 py-1 rounded-full text-xs font-medium" data-store="all">All Stores</button>
        </div>
        <ul id="history-list" class="space-y-2"></ul>
        <div id="history-empty" class="hidden text-center text-gray-500 italic p-6 border-2 border-dashed border-gray-200 rounded-xl">
          <i class="fas fa-book-open text-2xl mb-2"></i><p>No items bought yet.</p>
        </div>
      </section>

      <!-- Bill -->
      <section id="bill-section" class="page-section hidden space-y-4">
        <h2 class="text-lg font-bold text-gray-800">Generate Receipt</h2>
        <div class="p-4 bg-gray-50 rounded-xl border">
          <p class="text-sm font-semibold text-gray-700">Total Selected:</p>
          <p id="bill-total" class="text-3xl font-extrabold text-green-600 mt-1">$0.00</p>
        </div>
        <button id="print-bill-button" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-semibold shadow"> <i class="fas fa-print mr-2"></i> Generate Receipt</button>
        <h3 class="text-base font-semibold text-gray-700 pt-2">Select Items:</h3>
        <ul id="bill-selection-list" class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar"></ul>
        <div id="bill-empty" class="hidden text-center text-gray-500 italic p-6 border-2 border-dashed border-gray-200 rounded-xl">No history items available for billing.</div>
      </section>
    </main>

    <!-- Bottom Nav -->
    <nav class="app-bottom">
      <div class="flex justify-around">
        <button data-section="dashboard" class="nav-button flex flex-col items-center p-3 text-indigo-600" title="Home"><i class="fas fa-home text-2xl"></i></button>
        <button data-section="cart" class="nav-button flex flex-col items-center p-3 text-gray-500 hover:text-indigo-600" title="Cart"><i class="fas fa-shopping-cart text-2xl"></i></button>
        <button data-section="history" class="nav-button flex flex-col items-center p-3 text-gray-500 hover:text-indigo-600" title="History"><i class="fas fa-history text-2xl"></i></button>
        <button data-section="bill" class="nav-button flex flex-col items-center p-3 text-gray-500 hover:text-indigo-600" title="Receipt"><i class="fas fa-receipt text-2xl"></i></button>
      </div>
    </nav>
  </div>

  <!-- Slide-in Menu Drawer -->
  <div id="menu-drawer" class="drawer">
    <div class="scrim"></div>
    <aside class="panel p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold text-indigo-700">Menu</h3>
        <button id="close-drawer" class="p-2 rounded-full hover:bg-gray-100"><i class="fas fa-times"></i></button>
      </div>
      <div class="space-y-2">
        <button id="debts" class="w-full text-left p-3 rounded-lg hover:bg-gray-50"><i class="fas fa-user mr-2 text-indigo-600"></i>Debts</button>
        <button id="menu-backup" class="w-full text-left p-3 rounded-lg hover:bg-gray-50"><i class="fas fa-cloud-upload-alt mr-2 text-indigo-600"></i> Backup (Export JSON)</button>
        <button id="menu-restore" class="w-full text-left p-3 rounded-lg hover:bg-gray-50"><i class="fas fa-cloud-download-alt mr-2 text-indigo-600"></i> Restore (Import JSON)</button>
        <button id="menu-export-all" class="w-full text-left p-3 rounded-lg hover:bg-gray-50"><i class="fas fa-file-pdf mr-2 text-indigo-600"></i> Export All as PDF</button>
        <div class="flex items-center justify-between p-3 rounded-lg bg-gray-50">
          <span><i class="fas fa-moon mr-2 text-indigo-600"></i> Dark Mode</span>
          <label class="inline-flex items-center cursor-pointer">
            <input id="theme-toggle" type="checkbox" class="sr-only peer">
            <div class="w-10 h-6 bg-gray-300 rounded-full peer peer-checked:bg-indigo-600 relative after:content-[''] after:absolute after:w-5 after:h-5 after:bg-white after:rounded-full after:top-0.5 after:left-0.5 after:transition-all peer-checked:after:translate-x-4"></div>
          </label>
        </div>
      </div>
      <div class="mt-4 text-xs text-gray-500">All data is stored locally on your device.</div>
    </aside>
  </div>

  <!-- ExpenseShare Pro Overlay -->
  <div id="expense-share-overlay" class="overlay">
    <div class="h-full flex flex-col">
      <header class="p-4 bg-indigo-600 text-white shadow-lg sticky top-0 z-10 flex justify-between items-center">
        <div class="flex items-center gap-3">
          <button id="expense-share-back-button" class="p-2 rounded-full hover:bg-indigo-700"><i class="fas fa-arrow-left"></i></button>
          <h1 class="text-xl font-extrabold">ExpenseShare Pro</h1>
        </div>
        <div class="flex items-center gap-2">
          <button id="btn-exp-export" class="p-2 rounded-lg bg-white/20 hover:bg-white/30"><i class="fas fa-file-export"></i></button>
          <button id="add-expense-quick" class="px-3 py-2 bg-white/20 rounded-lg hover:bg-white/30"><i class="fas fa-plus-circle mr-2"></i>Add Expense</button>
          <button id="add-member-btn" class="p-2 rounded-full hover:bg-indigo-700" title="Add Member"><i class="fas fa-user-plus"></i></button>
        </div>
      </header>

      <main class="flex-1 overflow-y-auto custom-scrollbar p-4">
        <!-- Group Switcher -->
        <div class="bg-white p-4 rounded-xl shadow mb-4">
          <div class="flex items-center gap-2">
            <select id="group-select" class="flex-1 p-3 border rounded-lg text-sm"></select>
            <button id="new-group-btn" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm"><i class="fas fa-plus mr-1"></i>New Group</button>
          </div>
        </div>

        <!-- Summary Cards -->
        <div class="bg-white p-4 rounded-xl shadow mb-4">
          <div class="grid grid-cols-3 gap-3">
            <div class="text-center p-3 bg-indigo-50 rounded">
              <div id="group-total-spent" class="text-xl font-bold text-indigo-700">$0</div>
              <div class="text-xs text-indigo-600 font-medium">Total Spent</div>
            </div>
            <div class="text-center p-3 bg-green-50 rounded">
              <div id="group-members-count" class="text-xl font-bold text-green-700">0</div>
              <div class="text-xs text-green-600 font-medium">Members</div>
            </div>
            <div class="text-center p-3 bg-blue-50 rounded">
              <div id="group-expenses-count" class="text-xl font-bold text-blue-700">0</div>
              <div class="text-xs text-blue-600 font-medium">Expenses</div>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-3 mt-3">
            <div class="bg-gray-50 rounded p-3">
              <p class="text-sm font-semibold text-gray-700 mb-2">Member Contribution Chart</p>
              <div class="h-44"><canvas id="exp-group-chart"></canvas></div>
            </div>
            <div class="bg-gray-50 rounded p-3">
              <p class="text-sm font-semibold text-gray-700">Highlights</p>
              <p id="exp-highlights" class="text-sm text-gray-600 mt-1">Add a few expenses to see highlights.</p>
            </div>
          </div>

          <h3 class="mt-4 mb-2 font-semibold text-gray-800 flex items-center gap-2"><i class="fas fa-balance-scale text-indigo-500"></i>Net Balances</h3>
          <div id="net-balances" class="space-y-2"></div>
          <div id="no-balances" class="text-center text-gray-500 italic p-4 border-2 border-dashed rounded">No balances to display yet</div>

          <h3 class="mt-4 mb-2 font-semibold text-gray-800 flex items-center gap-2"><i class="fas fa-handshake text-indigo-500"></i>Settlements</h3>
          <div id="settlements-list" class="space-y-2"></div>
          <div id="no-settlements" class="text-center text-gray-500 italic p-4 border-2 border-dashed rounded">No settlements needed</div>
        </div>

        <!-- Recent -->
        <div class="bg-white p-4 rounded-xl shadow">
          <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2"><i class="fas fa-clock text-indigo-500"></i>Recent Expenses</h3>
          <div id="recent-expenses-list" class="space-y-2"></div>
          <div id="no-recent-expenses" class="text-center text-gray-500 italic p-4 border-2 border-dashed rounded">No recent expenses</div>
        </div>
      </main>
      <div class="h-16"></div>
    </div>
  </div>

  <!-- Money Tracker Overlay -->
  <div id="money-tracker-overlay" class="overlay">
    <div class="h-full flex flex-col">
      <header class="p-4 bg-indigo-600 text-white sticky top-0 z-10 flex justify-between items-center">
        <div class="flex items-center gap-3">
          <button id="money-back-button" class="p-2 rounded-full hover:bg-indigo-700"><i class="fas fa-arrow-left"></i></button>
          <h1 class="text-xl font-extrabold">Money Tracker</h1>
        </div>
        <div class="flex items-center gap-2">
          <button id="btn-wallet-export" class="p-2 rounded-full hover:bg-indigo-700" title="Export PDF"><i class="fas fa-file-export"></i></button>
          <button id="money-eye-button" class="p-2 rounded-full hover:bg-indigo-700"><i class="fas fa-eye"></i></button>
        </div>
      </header>

      <main class="flex-1 overflow-y-auto custom-scrollbar p-4">
        <div class="wallet-card mb-6">
          <div class="flex justify-between items-start mb-4">
            <div>
              <p class="text-sm opacity-80">Total Balance</p>
              <div id="money-display" class="text-3xl font-bold mt-1">$<span id="total-money-amount">0.00</span></div>
              <div id="hidden-money-display" class="hidden text-3xl font-bold mt-1"><i class="fas fa-eye-slash"></i> ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
            </div>
            <div class="text-right">
              <p class="text-sm opacity-80">Monthly Budget</p>
              <p class="text-lg font-bold">$<span id="monthly-budget">0.00</span></p>
            </div>
          </div>
          <div class="mb-4">
            <div class="flex justify-between text-xs font-medium mb-1">
              <span>Budget Usage</span><span id="budget-usage-percent">0%</span>
            </div>
            <div class="budget-progress"><div id="budget-progress-fill" class="budget-progress-fill bg-white" style="width:0%"></div></div>
          </div>
          <div class="flex justify-between">
            <button id="add-money-main-button" class="bg-white text-indigo-600 px-4 py-2 rounded-lg text-sm font-medium hover:scale-105"><i class="fas fa-plus mr-1"></i>Add Money</button>
            <button id="set-budget-button" class="bg-white text-indigo-600 px-4 py-2 rounded-lg text-sm font-medium hover:scale-105"><i class="fas fa-chart-pie mr-1"></i>Set Budget</button>
          </div>
        </div>

        <!-- AI Insights -->
        <div class="bg-white rounded-xl p-4 shadow mb-4">
          <div class="flex items-center justify-between">
            <p class="text-sm font-semibold text-gray-700">AI Insights</p>
            <button id="refresh-insights" class="px-3 py-1 rounded bg-indigo-50 text-indigo-700 text-xs">Refresh</button>
          </div>
          <p id="ai-insights-text" class="text-sm text-gray-600 mt-2">Add transactions to see insights.</p>
        </div>

        <!-- Add Money -->
        <div id="add-money-section" class="hidden bg-white p-4 rounded-xl border mb-6">
          <h3 class="text-sm font-medium text-gray-700 mb-2">Add Money to Wallet</h3>
          <div class="flex gap-2 mb-2">
            <input id="money-amount-input" type="number" step="0.01" class="flex-1 p-3 border rounded-lg text-sm focus:ring-indigo-500" placeholder="Amount"/>
            <button id="confirm-add-money" class="bg-indigo-600 text-white px-4 py-3 rounded-lg text-sm font-medium">Add</button>
          </div>
          <div class="grid grid-cols-4 gap-2">
            <button class="quick-amount-btn bg-gray-100 p-2 rounded-lg" data-amount="10">$10</button>
            <button class="quick-amount-btn bg-gray-100 p-2 rounded-lg" data-amount="20">$20</button>
            <button class="quick-amount-btn bg-gray-100 p-2 rounded-lg" data-amount="50">$50</button>
            <button class="quick-amount-btn bg-gray-100 p-2 rounded-lg" data-amount="100">$100</button>
          </div>
        </div>

        <!-- Wallet Analytics Tabs -->
        <div class="bg-white rounded-xl shadow p-4 mb-4">
          <div class="flex items-center gap-2">
            <button class="tab-btn px-3 py-1 rounded bg-gray-100 text-sm" data-range="daily">Daily</button>
            <button class="tab-btn px-3 py-1 rounded bg-gray-100 text-sm" data-range="weekly">Weekly</button>
            <button class="tab-btn px-3 py-1 rounded bg-gray-100 text-sm" data-range="monthly">Monthly</button>
          </div>
          <div class="h-44 mt-3"><canvas id="wallet-trend-chart"></canvas></div>
        </div>

        <!-- Savings Goals -->
        <div class="bg-white rounded-xl shadow p-4 mb-4">
          <div class="flex items-center justify-between">
            <p class="text-sm font-semibold text-gray-700">Savings Goals</p>
            <button id="add-goal-btn" class="px-3 py-1 rounded bg-indigo-50 text-indigo-700 text-xs"><i class="fas fa-plus mr-1"></i>Add Goal</button>
          </div>
          <div id="goals-wrap" class="mt-3 space-y-2"></div>
          <div id="no-goals" class="text-sm text-gray-500">No goals yet.</div>
        </div>

        <!-- Recurring Expenses -->
        <div class="bg-white rounded-xl shadow p-4 mb-6">
          <div class="flex items-center justify-between">
            <p class="text-sm font-semibold text-gray-700">Recurring Expenses (Monthly)</p>
            <button id="add-recurring-btn" class="px-3 py-1 rounded bg-indigo-50 text-indigo-700 text-xs"><i class="fas fa-plus mr-1"></i>Add</button>
          </div>
          <div id="recurring-wrap" class="mt-3 space-y-2"></div>
          <div id="no-recurring" class="text-sm text-gray-500">No recurring items.</div>
          <button id="apply-recurring" class="w-full mt-3 bg-indigo-600 text-white py-2 rounded-lg text-sm font-medium">Apply This Month</button>
        </div>

        <!-- KPIs -->
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-white rounded-xl p-4 shadow">
            <p class="text-xs text-gray-500 mb-1">Total Spent</p>
            <p class="text-lg font-bold text-gray-800">$<span id="wallet-total-spent">0.00</span></p>
          </div>
          <div class="bg-white rounded-xl p-4 shadow">
            <p class="text-xs text-gray-500 mb-1">Remaining</p>
            <p class="text-lg font-bold text-green-600">$<span id="remaining-budget">0.00</span></p>
          </div>
        </div>

        <!-- Spending by Category -->
        <div class="bg-white rounded-xl p-4 shadow mb-6">
          <p class="text-sm font-medium text-gray-700 mb-3">Spending by Category</p>
          <div class="h-40"><canvas id="spending-chart"></canvas></div>
        </div>

        <h3 class="text-lg font-bold text-gray-800 mb-3">Recent Transactions</h3>
        <div id="recent-transactions" class="space-y-2"></div>
        <div id="no-transactions" class="text-center text-gray-500 italic p-6 border-2 border-dashed rounded">No transactions yet</div>
      </main>
      <div class="h-16"></div>
    </div>
  </div>

  <!-- Templates -->
  <template id="cart-item-template">
    <li class="flex justify-between items-center p-3 bg-white border rounded-xl shadow-sm">
      <span class="item-name text-sm font-medium text-gray-700 truncate w-3/6"></span>
      <div class="flex gap-2">
        <button class="delete-btn text-red-500 hover:text-red-700 text-sm p-1 rounded-full" title="Delete"><i class="fas fa-trash-alt"></i></button>
        <button class="buy-btn bg-green-100 text-green-700 hover:bg-green-200 text-xs font-semibold px-3 py-1 rounded-full" title="Bought"><i class="fas fa-check-circle mr-1"></i>Bought</button>
      </div>
    </li>
  </template>

  <template id="history-item-template">
    <li class="flex justify-between items-center p-3 bg-white border rounded-xl">
      <div class="flex-1 overflow-hidden pr-2">
        <p class="item-name text-sm font-semibold text-gray-800 truncate"></p>
        <p class="item-store text-xs text-indigo-500 font-medium mt-0.5 flex items-center"><i class="fas fa-store mr-1"></i><span class="store-name"></span></p>
        <p class="item-details text-xs text-gray-500"></p>
        <p class="item-date text-xs text-gray-400"></p>
      </div>
      <p class="item-total-price text-base font-extrabold text-green-600"></p>
    </li>
  </template>

  <template id="bill-item-template">
    <li class="flex justify-between items-center p-3 bg-white border rounded-xl hover:bg-gray-100 cursor-pointer">
      <div class="flex items-center gap-3">
        <input type="checkbox" class="select-checkbox h-4 w-4 text-green-600 rounded"/>
        <p class="item-name text-sm font-medium text-gray-700"></p>
      </div>
      <p class="item-price text-sm font-semibold text-gray-600"></p>
    </li>
  </template>

  <!-- Modals -->
  <div id="add-member-modal" class="modal">
    <div class="bg-white p-5 rounded-xl w-full max-w-xs">
      <h3 class="text-lg font-bold text-indigo-600 mb-3">Add Group Member</h3>
      <input id="member-name" class="w-full p-3 border rounded-lg mb-3" placeholder="Member name"/>
      <div id="existing-members" class="space-y-1 mb-4"></div>
      <div class="flex justify-end gap-2">
        <button id="cancel-add-member" class="px-3 py-2">Cancel</button>
        <button id="confirm-add-member" class="px-3 py-2 bg-indigo-600 text-white rounded-lg">Add</button>
      </div>
    </div>
  </div>

  <div id="add-expense-modal" class="modal">
    <div class="bg-white p-5 rounded-xl w-full max-w-sm max-h-[90vh] overflow-y-auto custom-scrollbar">
      <h3 class="text-lg font-bold text-indigo-600 mb-3">Add Expense</h3>
      <div class="space-y-3">
        <input id="ex-title" class="w-full p-3 border rounded-lg" placeholder="Title (e.g., Dinner)"/>
        <input id="ex-amount" type="number" step="0.01" class="w-full p-3 border rounded-lg" placeholder="Amount"/>
        <div>
          <label class="text-sm font-medium">Paid By</label>
          <select id="ex-paid-by" class="w-full p-3 border rounded-lg mt-1"></select>
        </div>
        <div>
          <label class="text-sm font-medium">Split Type</label>
          <div class="grid grid-cols-2 gap-2 mt-1">
            <button class="split-type px-3 py-2 border rounded active" data-type="equal">Equal</button>
            <button class="split-type px-3 py-2 border rounded" data-type="shares">By Shares</button>
            <button class="split-type px-3 py-2 border rounded" data-type="percent">By Percent</button>
            <button class="split-type px-3 py-2 border rounded" data-type="exact">Exact Amounts</button>
          </div>
        </div>
        <div id="ex-members-list" class="space-y-2 mt-1"></div>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="cancel-add-expense" class="px-3 py-2">Cancel</button>
        <button id="confirm-add-expense" class="px-3 py-2 bg-indigo-600 text-white rounded-lg">Add</button>
      </div>
    </div>
  </div>

  <div id="print-modal" class="modal">
    <div class="bg-white p-4 rounded-xl w-full max-w-md h-[80vh] overflow-hidden flex flex-col">
      <div class="flex justify-between items-center mb-2 border-b pb-2">
        <h3 class="text-lg font-bold text-indigo-700">Final Receipt</h3>
        <div class="flex gap-2">
          <button id="export-pdf-button" class="p-2 rounded-full hover:bg-green-50 text-green-600" title="Export PDF"><i class="fas fa-file-pdf"></i></button>
          <button id="print-receipt-button" class="p-2 rounded-full hover:bg-blue-50 text-blue-600" title="Print"><i class="fas fa-print"></i></button>
          <button id="close-print-button" class="p-2 rounded-full hover:bg-gray-100"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="receipt-content" class="flex-1 overflow-auto text-sm p-2"></div>
    </div>
  </div>

  <div id="profile-modal" class="modal">
    <div class="bg-white p-5 rounded-xl w-full max-w-xs">
      <div class="text-center mb-4">
        <div class="relative inline-block">
          <div id="profile-pic-container" class="w-20 h-20 bg-indigo-100 rounded-full grid place-items-center mx-auto overflow-hidden cursor-pointer">
            <img id="profile-pic" class="hidden w-full h-full object-cover" alt=""/>
            <i id="profile-icon" class="fas fa-user text-3xl text-indigo-600"></i>
          </div>
          <input id="profile-pic-input" type="file" accept="image/*" class="hidden"/>
          <button id="change-profile-pic" class="absolute -bottom-1 -right-1 bg-indigo-600 text-white p-1 rounded-full text-xs"><i class="fas fa-camera"></i></button>
        </div>
        <input id="username-input" class="w-full p-2 border rounded-lg text-sm text-center mt-2" placeholder="Enter username"/>
        <p class="text-xs text-gray-500">Shopping Tracker User</p>
      </div>
      <div class="space-y-2">
        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
          <i class="fas fa-shopping-cart text-indigo-500 mr-3"></i>
          <div><p class="text-sm font-medium">Cart Items</p><p id="profile-cart-count" class="text-xs text-gray-500">0 items</p></div>
        </div>
        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
          <i class="fas fa-history text-green-500 mr-3"></i>
          <div><p class="text-sm font-medium">Purchase History</p><p id="profile-history-count" class="text-xs text-gray-500">0 items</p></div>
        </div>
        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
          <i class="fas fa-database text-blue-500 mr-3"></i>
          <div><p class="text-sm font-medium">Data Storage</p><p class="text-xs text-gray-500">Local Browser</p></div>
        </div>
      </div>
      <div class="mt-4 pt-3 border-t">
        <button id="clear-all-data" class="w-full bg-red-50 text-red-600 hover:bg-red-100 py-2 rounded-lg text-sm font-medium"><i class="fas fa-trash mr-2"></i>Clear All Data</button>
      </div>
      <div class="flex justify-end mt-3"><button id="close-profile-button" class="text-sm px-3 py-2">Close</button></div>
    </div>
  </div>

  <div id="budget-modal" class="modal">
    <div class="bg-white p-5 rounded-xl w-full max-w-xs">
      <h3 class="text-lg font-bold text-indigo-600 mb-3">Set Monthly Budget</h3>
      <input id="budget-amount-input" type="number" step="0.01" class="w-full p-3 border rounded-lg mb-3" placeholder="Budget amount"/>
      <div class="flex justify-end gap-2">
        <button id="cancel-budget-button" class="px-3 py-2">Cancel</button>
        <button id="confirm-budget-button" class="px-3 py-2 bg-indigo-600 text-white rounded-lg">Set Budget</button>
      </div>
    </div>
  </div>

  <!-- FABs -->
  <button id="chatbot-toggle" class="fab bg-indigo-600 text-white hidden" title="Shopping Assistant">ü§ñ</button>
  <button id="money-tracker-fab" class="fab bg-green-500 text-white hidden" title="Money Tracker"><i class="fas fa-wallet text-xl"></i></button>

  <!-- Chatbot Overlay -->
  <div id="chatbot-overlay">
    <header class="chat-header p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button id="chatbot-close" class="p-2 rounded-full hover:bg-white/20"><i class="fas fa-arrow-left"></i></button>
        <div>
          <h2 class="text-lg font-extrabold">Shopping Assistant Pro</h2>
          <p class="text-xs text-white/90">Ask about wallet, expenses, goals, and more.</p>
        </div>
      </div>
      <button id="chatbot-clear" class="p-2 rounded-full hover:bg-white/20" title="Clear"><i class="fas fa-trash"></i></button>
    </header>
    <div id="chatbot-messages" class="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-3">
      <div class="flex"><div class="bubble bot">Hi Parash! I can add expenses, split costs, show wallet stats, list purchases, export PDFs, and more. Try: ‚Äúlast 5 expenses‚Äù, ‚Äúwho owes me?‚Äù, ‚Äúadd ‚Ç©10000 to wallet‚Äù.</div></div>
    </div>
    <div class="p-3 chat-pane">
      <form id="chatbot-form" class="flex gap-2">
        <input id="chatbot-input" class="flex-1 p-3 rounded-lg border" placeholder="Type a message‚Ä¶"/>
        <button class="px-4 py-2 bg-white text-indigo-700 rounded-lg font-medium">Send</button>
      </form>
      <div id="typing" class="hidden mt-2 typing"><span></span><span></span><span></span></div>
    </div>
  </div>

  <script>
    /*************** Storage Keys ***************/
    const LS = {
      cart: 'st_cart',
      history: 'st_history',
      stores: 'st_stores',
      profile: 'st_profile',
      wallet: 'st_wallet',
      expMembers: 'st_expense_members',    // {groupId:[members]}
      expExpenses: 'st_group_expenses',    // {groupId:[expenses]}
      expGroups: 'st_expense_groups',      // [{id,name}]
      goals: 'st_goals',
      recurring: 'st_recurring',
      theme: 'st_theme'
    };
    const readLS = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } };
    const writeLS = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    /*************** App State ***************/
    let cart = readLS(LS.cart, []);
    let historyItems = readLS(LS.history, []);
    let stores = readLS(LS.stores, ['Default Store']);
    let profile = readLS(LS.profile, { username:'', pic:'' });
    let wallet = readLS(LS.wallet, { balance:0, budget:0, tx:[], byCategory:{} });
    let groups = readLS(LS.expGroups, [{id:uid(), name:'Default Group'}]);
    let groupMembers = readLS(LS.expMembers, {[groups[0].id]:[]});
    let groupExpenses = readLS(LS.expExpenses, {[groups[0].id]:[]});
    let currentGroupId = groups[0].id;
    if(!groupMembers[currentGroupId]) groupMembers[currentGroupId]=[];
    if(!groupExpenses[currentGroupId]) groupExpenses[currentGroupId]=[];

    let goals = readLS(LS.goals, []);          // [{id,title,target,saved}]
    let recurring = readLS(LS.recurring, []);  // [{id,label,amount,category}]
    let theme = readLS(LS.theme, 'light');

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    /*************** Refs (many) ***************/
    const navButtons = $$('.nav-button');
    const sections = {
      dashboard: $('#dashboard-section'),
      cart: $('#cart-section'),
      history: $('#history-section'),
      bill: $('#bill-section')
    };

    const expenseShareBtn = $('#expense-share-btn');
    const expenseShareOverlay = $('#expense-share-overlay');
    const expenseShareBackBtn = $('#expense-share-back-button');
    const addMemberModal = $('#add-member-modal');
    const addMemberBtn = $('#add-member-btn');
    const confirmAddMember = $('#confirm-add-member');
    const cancelAddMember = $('#cancel-add-member');
    const memberNameInput = $('#member-name');
    const existingMembersWrap = $('#existing-members');

    const groupSelect = $('#group-select');
    const newGroupBtn = $('#new-group-btn');
    const expHighlights = $('#exp-highlights');
    const btnExpExport = $('#btn-exp-export');

    const addExpenseModal = $('#add-expense-modal');
    const addExpenseQuick = $('#add-expense-quick');
    const exTitle = $('#ex-title');
    const exAmount = $('#ex-amount');
    const exPaidBy = $('#ex-paid-by');
    const exMembersList = $('#ex-members-list');
    let splitType = 'equal';

    const groupTotalSpent = $('#group-total-spent');
    const groupMembersCount = $('#group-members-count');
    const groupExpensesCount = $('#group-expenses-count');
    const netBalancesWrap = $('#net-balances');
    const noBalances = $('#no-balances');
    const settlementsWrap = $('#settlements-list');
    const noSettlements = $('#no-settlements');
    const recentExpensesList = $('#recent-expenses-list');
    const noRecentExpenses = $('#no-recent-expenses');

    const moneyOverlay = $('#money-tracker-overlay');
    const moneyFab = $('#money-tracker-fab');
    const moneyBackBtn = $('#money-back-button');
    const moneyEyeBtn = $('#money-eye-button');
    const moneyDisplay = $('#money-display');
    const hiddenMoneyDisplay = $('#hidden-money-display');
    const addMoneyMainBtn = $('#add-money-main-button');
    const addMoneySection = $('#add-money-section');
    const moneyAmountInput = $('#money-amount-input');
    const confirmAddMoney = $('#confirm-add-money');
    const quickAmountBtns = $$('.quick-amount-btn');
    const setBudgetBtn = $('#set-budget-button');
    const budgetModal = $('#budget-modal');
    const budgetAmountInput = $('#budget-amount-input');
    const cancelBudgetBtn = $('#cancel-budget-button');
    const confirmBudgetBtn = $('#confirm-budget-button');
    const monthlyBudgetEl = $('#monthly-budget');
    const budgetUsagePercent = $('#budget-usage-percent');
    const budgetProgressFill = $('#budget-progress-fill');
    const walletTotalSpent = $('#wallet-total-spent');
    const remainingBudget = $('#remaining-budget');
    const recentTxWrap = $('#recent-transactions');
    const noTx = $('#no-transactions');

    const btnWalletExport = $('#btn-wallet-export');
    const tabBtns = $$('.tab-btn');
    let trendRange = 'daily';
    let trendChart = null;

    const goalsWrap = $('#goals-wrap');
    const noGoals = $('#no-goals');
    const addGoalBtn = $('#add-goal-btn');

    const recurringWrap = $('#recurring-wrap');
    const noRecurring = $('#no-recurring');
    const addRecurringBtn = $('#add-recurring-btn');
    const applyRecurringBtn = $('#apply-recurring');

    const chatbotFab = $('#chatbot-toggle');
    const chatbotOverlay = $('#chatbot-overlay');
    const chatbotClose = $('#chatbot-close');
    const chatbotForm = $('#chatbot-form');
    const chatbotInput = $('#chatbot-input');
    const chatbotMessages = $('#chatbot-messages');
    const chatbotTyping = $('#typing');
    const chatbotClear = $('#chatbot-clear');

    const itemNameInput = $('#item-name-input');
    const addItemBtn = $('#add-item-button');
    const dashboardCartCount = $('#dashboard-cart-count');
    const dashboardTotalSpent = $('#dashboard-total-spent');
    const cartList = $('#cart-list');
    const cartEmpty = $('#cart-empty');
    const cartCount = $('#cart-count');

    const historyList = $('#history-list');
    const historyEmpty = $('#history-empty');
    const historyFilterBtn = $('#history-filter-btn');
    const storeFilters = $('#store-filters');

    const billSelectionList = $('#bill-selection-list');
    const billEmpty = $('#bill-empty');
    const billTotal = $('#bill-total');
    const printBillButton = $('#print-bill-button');
    const printModal = $('#print-modal');
    const receiptContent = $('#receipt-content');
    const printClose = $('#close-print-button');
    const exportPdfButton = $('#export-pdf-button');
    const printReceiptButton = $('#print-receipt-button');

    const profileBtn = $('#profile-button');
    const profileModal = $('#profile-modal');
    const profileCartCount = $('#profile-cart-count');
    const profileHistoryCount = $('#profile-history-count');
    const profilePicInput = $('#profile-pic-input');
    const changeProfilePic = $('#change-profile-pic');
    const profilePic = $('#profile-pic');
    const profileIcon = $('#profile-icon');
    const profilePicSmallImg = $('#profile-pic-small-img');
    const profileIconSmall = $('#profile-icon-small');
    const usernameInput = $('#username-input');
    const clearAllDataBtn = $('#clear-all-data');
    const closeProfileBtn = $('#close-profile-button');

    const searchToggleBtn = $('#search-toggle-btn');
    const searchInput = $('#search-input');

    const menuBtn = $('#menu-button');
    const drawer = $('#menu-drawer');
    const drawerScrim = drawer.querySelector('.scrim');
    const closeDrawerBtn = $('#close-drawer');
    const menudebts = $('#debts');
    const menuBackup = $('#menu-backup');
    const menuRestore = $('#menu-restore');
    const menuExportAll = $('#menu-export-all');
    const themeToggle = $('#theme-toggle');

    const tileExpenseShare = $('#tile-expenseshare');
    const tileWallet = $('#tile-wallet');
    const tileJournal = $('#tile-journal');
    const tileTodo = $('#tile-todo');
    const tipEl = $('#finance-tip');
    const todayAvgBadge = $('#today-vs-avg-badge');
    const todayAvgText = $('#today-vs-avg-text');

    /*************** Utils ***************/
    function uid(){ return Math.random().toString(36).slice(2,9); }
    function fmt(n){ return (n||0).toFixed(2); }
    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }
    function openModal(el){ el.classList.add('flex'); }
    function closeModal(el){ el.classList.remove('flex'); }
    function openDrawer(){ drawer.classList.add('active'); }
    function closeDrawer(){ drawer.classList.remove('active'); }
    function nowISO(){ return new Date().toISOString(); }

    /*************** Navigation + FABs ***************/
    function showSection(key){
      Object.entries(sections).forEach(([k,el])=>{
        if(k===key){ el.classList.remove('hidden'); el.classList.add('animate-fadeInUp'); }
        else{ el.classList.add('hidden'); el.classList.remove('animate-fadeInUp'); }
      });
      navButtons.forEach(btn=>{
        const active = btn.dataset.section===key;
        btn.classList.toggle('text-indigo-600',active);
        btn.classList.toggle('text-gray-500',!active);
      });
      expenseShareBtn.classList.toggle('hidden', key!=='dashboard');

      // FABs
      chatbotFab.classList.toggle('hidden', key!=='dashboard');   // only Home
      moneyFab.classList.toggle('hidden', key!=='history');       // only History
    }
    navButtons.forEach(b=>b.addEventListener('click',()=>showSection(b.dataset.section)));
    showSection('dashboard');

    /*************** Finance Tip + Today vs Average ***************/
    const tips = [
      "Pay yourself first: move savings on payday.",
      "Track small recurring subscriptions‚Äîthey add up.",
      "Cook once, eat twice: lower food costs.",
      "Use categories to see where your money leaks.",
      "Set realistic monthly budgets‚Äîthen review weekly."
    ];
    function setDailyTip(){
      const idx = new Date().getDate() % tips.length;
      tipEl.textContent = tips[idx];
    }
    function computeTodayVsAverage(){
      const today = new Date().toDateString();
      let todaySpent = 0, total=0, days = new Set();
      historyItems.forEach(h=>{
        const d = new Date(h.date);
        days.add(d.toDateString());
        total += h.total;
        if(d.toDateString()===today) todaySpent += h.total;
      });
      const avg = days.size ? (total / days.size) : 0;
      const diff = avg ? ((todaySpent-avg)/avg)*100 : 0;
      todayAvgBadge.textContent = `$${fmt(todaySpent)} / avg $${fmt(avg)}`;
      todayAvgText.textContent = avg ? (diff>=0 ? `You're ${diff.toFixed(0)}% above your daily average.` : `You're ${Math.abs(diff).toFixed(0)}% below your daily average.`)
                                     : `No average yet ‚Äî add some purchases.`;
    }

    /*************** Drawer / Theme ***************/
    menuBtn.onclick = openDrawer; closeDrawerBtn.onclick = closeDrawer; drawerScrim.onclick = closeDrawer;
    menuProfile.onclick = ()=>{ closeDrawer(); openProfile(); };
    menuBackup.onclick = ()=>{
      const blob = new Blob([JSON.stringify({
        cart, historyItems, stores, profile, wallet, groups, groupMembers, groupExpenses, goals, recurring, theme
      }, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup.json'; a.click();
    };
    menuRestore.onclick = ()=>{
      const inp = document.createElement('input');
      inp.type='file'; inp.accept='application/json';
      inp.onchange = e=>{
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = ()=>{
          try{
            const data = JSON.parse(r.result);
            cart=data.cart||cart; historyItems=data.historyItems||historyItems; stores=data.stores||stores;
            profile=data.profile||profile; wallet=data.wallet||wallet;
            groups=data.groups||groups; groupMembers=data.groupMembers||groupMembers; groupExpenses=data.groupExpenses||groupExpenses;
            goals=data.goals||goals; recurring=data.recurring||recurring; theme=data.theme||theme;
            persistAll(); renderAll();
            alert('Restore complete.');
          }catch{ alert('Invalid backup.'); }
        };
        r.readAsText(f);
      };
      inp.click();
    };
    menuExportAll.onclick = ()=>{
      const container = document.createElement('div');
      container.innerHTML = `
        <h2 style="font-weight:800;font-size:18px">Smart Finance Assistant ‚Äî Export</h2>
        <p>Date: ${new Date().toLocaleString()}</p>
        <hr/>
        <h3>Wallet Summary</h3>
        <p>Balance: $${fmt(wallet.balance)} | Budget: $${fmt(wallet.budget)}</p>
        <h3>Goals</h3>
        <ul>${goals.map(g=>`<li>${g.title}: $${fmt(g.saved)}/$${fmt(g.target)}</li>`).join('')||'<i>No goals</i>'}</ul>
        <h3>Recurring</h3>
        <ul>${recurring.map(r=>`<li>${r.label}: -$${fmt(r.amount)} (${r.category||'General'})</li>`).join('')||'<i>None</i>'}</ul>
        <h3>Recent Wallet Transactions</h3>
        <ul>${(wallet.tx||[]).slice(0,20).map(t=>`<li>${t.label}: ${t.amount<0?'-':'+'}$${fmt(Math.abs(t.amount))} (${new Date(t.date).toLocaleString()})</li>`).join('')||'<i>No transactions</i>'}</ul>
        <h3>Purchase History (${historyItems.length})</h3>
        <ul>${historyItems.slice(0,30).map(h=>`<li>${h.name} @ ${h.store}: $${fmt(h.total)} (${new Date(h.date).toLocaleString()})</li>`).join('')||'<i>Empty</i>'}</ul>
      `;
      html2pdf().from(container).set({filename:`export-all-${Date.now()}.pdf`}).save();
    };
    // Theme
    function applyTheme(){
      const isDark = theme==='dark';
      document.documentElement.classList.toggle('dark', isDark);
      document.body.style.background = isDark ? '#0b1220' : '#f8f8f8';
      themeToggle.checked = isDark;
    }
    themeToggle.onchange = ()=>{ theme = themeToggle.checked?'dark':'light'; writeLS(LS.theme, theme); applyTheme(); };

    /*************** Cart ***************/
    function renderCart(){
      cartList.innerHTML = '';
      cartCount.textContent = cart.length;
      dashboardCartCount.textContent = cart.length;
      cartEmpty.classList.toggle('hidden', cart.length>0);
      cart.forEach((name, idx)=>{
        const tpl = document.getElementById('cart-item-template').content.cloneNode(true);
        tpl.querySelector('.item-name').textContent = name;
        tpl.querySelector('.delete-btn').addEventListener('click', ()=>{
          cart.splice(idx,1); writeLS(LS.cart,cart); renderCart();
        });
        tpl.querySelector('.buy-btn').addEventListener('click', ()=>{
          const store = prompt('Bought from (store name):', stores[0]||'Default Store') || 'Default Store';
          if(!stores.includes(store)) { stores.push(store); writeLS(LS.stores,stores); }
          const qty = Number(prompt('Quantity:', '1')||'1');
          const unit = Number(prompt('Unit price:', '1')||'1');
          const item = { name, store, qty, unit, total: +(qty*unit).toFixed(2), date: nowISO() };
          historyItems.unshift(item);
          wallet.byCategory[store] = (wallet.byCategory[store]||0) + item.total;
          wallet.tx.unshift({label:`${name} @ ${store}`, amount:-item.total, date:item.date, icon:'fa-basket-shopping'});
          writeLS(LS.wallet,wallet); writeLS(LS.history,historyItems);
          cart.splice(idx,1); writeLS(LS.cart,cart);
          renderCart(); renderHistory(); renderWallet(); computeTodayVsAverage(); updateInsights();
        });
        cartList.appendChild(tpl);
      });
    }
    addItemBtn.addEventListener('click', ()=>{
      const v = itemNameInput.value.trim();
      if(!v) return alert('Enter an item name');
      cart.push(v); writeLS(LS.cart,cart); itemNameInput.value=''; renderCart();
    });

    /*************** History ***************/
    function renderHistory(filter='all'){
      historyList.innerHTML='';
      const items = filter==='all'? historyItems : historyItems.filter(h=>h.store===filter);
      if(historyItems.length===0){ show(historyEmpty); } else { hide(historyEmpty); }
      const uniqueStores = [...new Set(historyItems.map(h=>h.store))];
      storeFilters.innerHTML = '<button class="store-filter-btn bg-indigo-600 text-white px-3 py-1 rounded-full text-xs font-medium" data-store="all">All Stores</button>';
      uniqueStores.forEach(s=>{
        const btn = document.createElement('button');
        btn.className='store-filter-btn bg-gray-100 px-3 py-1 rounded-full text-xs font-medium';
        btn.dataset.store = s; btn.textContent = s;
        storeFilters.appendChild(btn);
      });
      $$('button.store-filter-btn').forEach(btn=>{ btn.onclick = ()=>renderHistory(btn.dataset.store); });

      let totalSpent = 0;
      items.forEach(h=>{
        const tpl = document.getElementById('history-item-template').content.cloneNode(true);
        tpl.querySelector('.item-name').textContent = h.name;
        tpl.querySelector('.store-name').textContent = h.store;
        tpl.querySelector('.item-details').textContent = `Qty: ${h.qty} ‚Ä¢ Unit: $${fmt(h.unit)}`;
        tpl.querySelector('.item-date').textContent = new Date(h.date).toLocaleString();
        tpl.querySelector('.item-total-price').textContent = `$${fmt(h.total)}`;
        totalSpent += h.total;
        historyList.appendChild(tpl);
      });
      dashboardTotalSpent.textContent = `$${(totalSpent||0).toFixed(0)}`;

      // Bill list
      billSelectionList.innerHTML='';
      if(historyItems.length===0) show(billEmpty); else hide(billEmpty);
      historyItems.forEach(h=>{
        const tpl = document.getElementById('bill-item-template').content.cloneNode(true);
        tpl.querySelector('.item-name').textContent = `${h.name} (${h.store})`;
        tpl.querySelector('.item-price').textContent = `$${fmt(h.total)}`;
        tpl.querySelector('.select-checkbox').addEventListener('change', computeBillTotal);
        billSelectionList.appendChild(tpl);
      });
      computeBillTotal();
    }
    function computeBillTotal(){
      let sum = 0;
      billSelectionList.querySelectorAll('li').forEach(li=>{
        if(li.querySelector('.select-checkbox').checked){
          const val = Number(li.querySelector('.item-price').textContent.replace('$',''))||0;
          sum += val;
        }
      });
      billTotal.textContent = `$${fmt(sum)}`;
    }
    printBillButton.onclick = ()=>{
      const total = billTotal.textContent;
      let html = `<div class="text-center">
        <h2 class="text-xl font-bold">Receipt</h2>
        <p class="text-sm text-gray-500">${new Date().toLocaleString()}</p>
      </div><hr class="my-2"/>`;
      html += '<div>';
      billSelectionList.querySelectorAll('li').forEach(li=>{
        if(li.querySelector('.select-checkbox').checked){
          const name = li.querySelector('.item-name').textContent;
          const price = li.querySelector('.item-price').textContent;
          html += `<div class="flex justify-between py-1"><span>${name}</span><span>${price}</span></div>`;
        }
      });
      html += `</div><hr class="my-2"/><div class="flex justify-between font-bold"><span>Total</span><span>${total}</span></div>`;
      receiptContent.innerHTML = html;
      openModal(printModal);
    };
    printClose.onclick = ()=> closeModal(printModal);
    exportPdfButton.onclick = ()=> html2pdf().from(receiptContent).set({filename:`receipt-${Date.now()}.pdf`}).save();
    printReceiptButton.onclick = ()=> window.print();

    /*************** Profile ***************/
    profileBtn.onclick = ()=> openProfile();
    closeProfileBtn.onclick = ()=> closeModal(profileModal);
    changeProfilePic.onclick = ()=> profilePicInput.click();
    profilePicInput.onchange = e=>{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{ profile.pic=r.result; writeLS(LS.profile,profile); applyProfile(); };
      r.readAsDataURL(f);
    };
    usernameInput.onchange = ()=>{ profile.username = usernameInput.value; writeLS(LS.profile,profile); };
    clearAllDataBtn.onclick = ()=>{
      if(confirm('Clear all local data?')){
        Object.values(LS).forEach(k=>localStorage.removeItem(k));
        location.reload();
      }
    };
    function openProfile(){
      applyProfile();
      profileCartCount.textContent = `${cart.length} items`;
      profileHistoryCount.textContent = `${historyItems.length} items`;
      openModal(profileModal);
    }
    function applyProfile(){
      usernameInput.value = profile.username||'';
      if(profile.pic){
        profilePic.src = profile.pic; profilePic.classList.remove('hidden'); profileIcon.classList.add('hidden');
        profilePicSmallImg.src = profile.pic; profilePicSmallImg.classList.remove('hidden'); profileIconSmall.classList.add('hidden');
      }else{
        profilePic.classList.add('hidden'); profileIcon.classList.remove('hidden');
        profilePicSmallImg.classList.add('hidden'); profileIconSmall.classList.remove('hidden');
      }
    }

    /*************** Wallet ***************/
    function renderWallet(){
      $('#total-money-amount').textContent = fmt(wallet.balance);
      monthlyBudgetEl.textContent = fmt(wallet.budget);
      const spent = (wallet.tx||[]).filter(t=>t.amount<0).reduce((a,t)=>a+(-t.amount),0);
      walletTotalSpent.textContent = fmt(spent);
      const remaining = Math.max(0, (wallet.budget||0) - spent);
      remainingBudget.textContent = fmt(remaining);
      const usage = (wallet.budget||0)>0 ? Math.min(100, (spent/wallet.budget)*100) : 0;
      budgetUsagePercent.textContent = `${usage.toFixed(0)}%`;
      budgetProgressFill.style.width = `${usage}%`;

      recentTxWrap.innerHTML = '';
      if(!wallet.tx || wallet.tx.length===0){ show(noTx); } else { hide(noTx); }
      (wallet.tx||[]).slice(0,20).forEach(t=>{
        const row = document.createElement('div');
        row.className='flex justify-between items-center p-3 bg-white border rounded-xl';
        row.innerHTML = `
          <div class="flex items-center">
            <div class="w-10 h-10 rounded-full grid place-items-center mr-3 bg-gray-100"><i class="fas ${t.icon||'fa-circle'}"></i></div>
            <div><p class="text-sm font-medium text-gray-700">${t.label}</p><p class="text-xs text-gray-500">${new Date(t.date).toLocaleString()}</p></div>
          </div>
          <p class="text-sm font-bold ${t.amount<0?'text-red-600':'text-green-600'}">${t.amount<0?'-':'+'}$${fmt(Math.abs(t.amount))}</p>
        `;
        recentTxWrap.appendChild(row);
      });

      // Spending by category doughnut
      const ctx = document.getElementById('spending-chart');
      const data = wallet.byCategory||{};
      const labels = Object.keys(data);
      const values = Object.values(data);
      if(!window._spendChart){
        window._spendChart = new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data:values}]}, options:{plugins:{legend:{display:true}}}});
      }else{
        window._spendChart.data.labels = labels;
        window._spendChart.data.datasets[0].data = values;
        window._spendChart.update();
      }

      // Trend chart
      renderTrendChart();
    }
    moneyFab.onclick = ()=>{ moneyOverlay.classList.add('active'); renderWallet(); updateInsights(); };
    moneyBackBtn.onclick = ()=> moneyOverlay.classList.remove('active');
    moneyEyeBtn.onclick = ()=>{
      const hidden = !hiddenMoneyDisplay.classList.contains('hidden');
      if(hidden){ hide(hiddenMoneyDisplay); show(moneyDisplay); }
      else{ show(hiddenMoneyDisplay); hide(moneyDisplay); }
    };
    addMoneyMainBtn.onclick = ()=> addMoneySection.classList.toggle('hidden');
    quickAmountBtns.forEach(b=> b.onclick = ()=> { moneyAmountInput.value = Number(b.dataset.amount).toFixed(2); });
    confirmAddMoney.onclick = ()=>{
      const amt = Number(moneyAmountInput.value||0);
      if(!amt) return;
      wallet.balance += amt;
      wallet.tx.unshift({label:'Wallet top-up', amount:amt, date:nowISO(), icon:'fa-wallet'});
      writeLS(LS.wallet,wallet); moneyAmountInput.value=''; renderWallet(); updateInsights();
    };
    setBudgetBtn.onclick = ()=>{ budgetAmountInput.value = wallet.budget||0; openModal(budgetModal); };
    cancelBudgetBtn.onclick = ()=> closeModal(budgetModal);
    confirmBudgetBtn.onclick = ()=>{
      const b = Number(budgetAmountInput.value||0);
      wallet.budget = b; writeLS(LS.wallet,wallet);
      closeModal(budgetModal); renderWallet(); updateInsights();
    };
    btnWalletExport.onclick = ()=>{
      const div = document.createElement('div');
      div.innerHTML = `
        <h2 style="font-weight:800;font-size:18px">Wallet Summary</h2>
        <p>Date: ${new Date().toLocaleString()}</p><hr/>
        <p>Balance: $${fmt(wallet.balance)} | Budget: $${fmt(wallet.budget)}</p>
        <h3>Recent Transactions</h3>
        <ul>${(wallet.tx||[]).slice(0,30).map(t=>`<li>${t.label}: ${t.amount<0?'-':'+'}$${fmt(Math.abs(t.amount))} (${new Date(t.date).toLocaleString()})</li>`).join('')}</ul>
      `;
      html2pdf().from(div).set({filename:`wallet-${Date.now()}.pdf`}).save();
    };

    // Trend chart renderer
    function renderTrendChart(){
      const ctx = document.getElementById('wallet-trend-chart');
      const points = buildTrendPoints(trendRange);
      if(!trendChart){
        trendChart = new Chart(ctx,{type:'line',data:{labels:points.labels,datasets:[{data:points.values, tension:.35}]}, options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}});
      }else{
        trendChart.data.labels = points.labels;
        trendChart.data.datasets[0].data = points.values;
        trendChart.update();
      }
    }
    tabBtns.forEach(b=> b.onclick = ()=>{ trendRange=b.dataset.range; renderTrendChart(); });

    function buildTrendPoints(range){
      // from wallet.tx negatives only
      const tx = (wallet.tx||[]).filter(t=>t.amount<0);
      const map = new Map();
      tx.forEach(t=>{
        const d = new Date(t.date);
        let key;
        if(range==='daily'){ key = d.toDateString(); }
        else if(range==='weekly'){ const wk = `${d.getFullYear()}-W${getWeek(d)}`; key = wk; }
        else{ key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
        map.set(key, (map.get(key)||0) + Math.abs(t.amount));
      });
      const labels = Array.from(map.keys());
      const values = labels.map(k=> +map.get(k).toFixed(2));
      return {labels, values};
    }
    function getWeek(d){ // ISO-ish week number
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = d.getUTCDay() || 7; d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart)/86400000) + 1)/7);
    }

    // AI Insights
    const insightsEl = $('#ai-insights-text');
    $('#refresh-insights').onclick = updateInsights;
    function updateInsights(){
      const spent = (wallet.tx||[]).filter(t=>t.amount<0).reduce((a,t)=>a+(-t.amount),0);
      const biggestCat = Object.entries(wallet.byCategory||{}).sort((a,b)=>b[1]-a[1])[0];
      const usage = (wallet.budget||0)>0 ? Math.min(100, (spent/wallet.budget)*100) : 0;
      insightsEl.textContent = biggestCat
        ? `You've used ${usage.toFixed(0)}% of your budget. Largest category: ${biggestCat[0]} ($${fmt(biggestCat[1])}).`
        : `No categories yet ‚Äî start buying to see insights.`;
    }

    // Goals
    function renderGoals(){
      goalsWrap.innerHTML=''; goals.length? hide(noGoals):show(noGoals);
      goals.forEach(g=>{
        const row = document.createElement('div');
        row.className='p-3 rounded border flex items-center justify-between';
        const pct = g.target>0? Math.min(100,(g.saved/g.target)*100):0;
        row.innerHTML = `
          <div class="flex-1 mr-3">
            <p class="text-sm font-semibold text-gray-700">${g.title}</p>
            <div class="goal-progress mt-1"><div class="goal-progress-fill" style="width:${pct}%;"></div></div>
            <p class="text-xs text-gray-500 mt-1">$${fmt(g.saved)} / $${fmt(g.target)}</p>
          </div>
          <div class="flex flex-col gap-1">
            <button class="add btn px-2 py-1 bg-green-50 text-green-700 rounded text-xs">+ Add</button>
            <button class="edit btn px-2 py-1 bg-gray-50 text-gray-700 rounded text-xs">Edit</button>
            <button class="del btn px-2 py-1 bg-red-50 text-red-600 rounded text-xs">Del</button>
          </div>`;
        const add = row.querySelector('.add'); const edit=row.querySelector('.edit'); const del=row.querySelector('.del');
        add.onclick = ()=>{
          const amt = Number(prompt('Add amount to goal:', '10')||'0');
          if(amt>0){ g.saved += amt; writeLS(LS.goals, goals); renderGoals(); }
        };
        edit.onclick = ()=>{
          const t = prompt('Goal title:', g.title)||g.title;
          const target = Number(prompt('Target amount:', g.target)||g.target);
          g.title=t; g.target=target; writeLS(LS.goals,goals); renderGoals();
        };
        del.onclick = ()=>{
          if(confirm('Delete goal?')){ goals = goals.filter(x=>x.id!==g.id); writeLS(LS.goals, goals); renderGoals(); }
        };
        goalsWrap.appendChild(row);
      });
    }
    addGoalBtn.onclick = ()=>{
      const title = prompt('Goal title (e.g., Laptop):'); if(!title) return;
      const target = Number(prompt('Target amount:', '500')||'0');
      goals.push({id:uid(), title, target, saved:0});
      writeLS(LS.goals, goals); renderGoals();
    };

    // Recurring
    function renderRecurring(){
      recurringWrap.innerHTML=''; recurring.length? hide(noRecurring):show(noRecurring);
      recurring.forEach(r=>{
        const row = document.createElement('div');
        row.className='p-3 rounded border flex items-center justify-between';
        row.innerHTML = `
          <div>
            <p class="text-sm font-semibold text-gray-700">${r.label}</p>
            <p class="text-xs text-gray-500">-$${fmt(r.amount)} ‚Ä¢ ${r.category||'General'}</p>
          </div>
          <div class="flex gap-1">
            <button class="edit px-2 py-1 rounded bg-gray-50 text-xs">Edit</button>
            <button class="del px-2 py-1 rounded bg-red-50 text-red-600 text-xs">Del</button>
          </div>`;
        row.querySelector('.edit').onclick = ()=>{
          const label = prompt('Label:', r.label)||r.label;
          const amount = Number(prompt('Amount:', r.amount)||r.amount);
          const category = prompt('Category:', r.category||'General')||(r.category||'General');
          r.label=label; r.amount=amount; r.category=category; writeLS(LS.recurring,recurring); renderRecurring();
        };
        row.querySelector('.del').onclick = ()=>{
          if(confirm('Delete recurring item?')){ recurring = recurring.filter(x=>x.id!==r.id); writeLS(LS.recurring,recurring); renderRecurring(); }
        };
        recurringWrap.appendChild(row);
      });
    }
    addRecurringBtn.onclick = ()=>{
      const label = prompt('Label (e.g., Rent):'); if(!label) return;
      const amount = Number(prompt('Amount (monthly):','50')||'0');
      const category = prompt('Category (e.g., Housing):','Housing')||'General';
      recurring.push({id:uid(), label, amount, category});
      writeLS(LS.recurring,recurring); renderRecurring();
    };
    applyRecurringBtn.onclick = ()=>{
      if(!recurring.length) return alert('No recurring items.');
      const ts = nowISO();
      recurring.forEach(r=>{
        wallet.byCategory[r.category] = (wallet.byCategory[r.category]||0) + r.amount;
        wallet.tx.unshift({label:`Recurring: ${r.label}`, amount:-r.amount, date:ts, icon:'fa-rotate'});
      });
      writeLS(LS.wallet,wallet); renderWallet(); updateInsights();
      alert('Applied this month\'s recurring expenses.');
    };

    /*************** ExpenseShare Pro (Multi-Group) ***************/
    function getMembers(){ return groupMembers[currentGroupId] || []; }
    function getExpenses(){ return groupExpenses[currentGroupId] || []; }
    function saveMembers(){ writeLS(LS.expMembers, groupMembers); }
    function saveExpenses(){ writeLS(LS.expExpenses, groupExpenses); }
    function saveGroups(){ writeLS(LS.expGroups, groups); }

    function populateGroupSelect(){
      groupSelect.innerHTML='';
      groups.forEach(g=>{
        const opt = document.createElement('option');
        opt.value=g.id; opt.textContent=g.name; if(g.id===currentGroupId) opt.selected=true;
        groupSelect.appendChild(opt);
      });
    }
    groupSelect.onchange = ()=>{ currentGroupId = groupSelect.value; ensureGroupBuckets(); renderExpenseShare(); };
    function ensureGroupBuckets(){
      if(!groupMembers[currentGroupId]) groupMembers[currentGroupId]=[];
      if(!groupExpenses[currentGroupId]) groupExpenses[currentGroupId]=[];
      saveMembers(); saveExpenses();
    }
    newGroupBtn.onclick = ()=>{
      const name = prompt('New group name (e.g., Trip to Seoul):'); if(!name) return;
      const id = uid();
      groups.push({id, name}); saveGroups();
      groupMembers[id]=[]; groupExpenses[id]=[]; saveMembers(); saveExpenses();
      currentGroupId = id; populateGroupSelect(); renderExpenseShare();
    };

    function openAddMember(){
      memberNameInput.value='';
      renderMembersInModal();
      openModal(addMemberModal);
    }
    function closeAddMember(){ closeModal(addMemberModal); }
    addMemberBtn.onclick = (e)=>{ e.preventDefault(); openAddMember(); };
    cancelAddMember.onclick = closeAddMember;
    confirmAddMember.onclick = ()=>{
      const name = memberNameInput.value.trim();
      if(!name) return;
      groupMembers[currentGroupId].push({id:uid(), name, active:true});
      saveMembers(); closeAddMember(); renderExpenseShare();
    };
    function renderMembersInModal(){
      existingMembersWrap.innerHTML = '';
      getMembers().forEach(m=>{
        const row = document.createElement('div');
        row.className='flex items-center justify-between p-2 bg-gray-50 rounded';
        row.innerHTML = `<span class="text-sm font-medium">${m.name}</span>
          <button class="text-red-600 text-xs">Remove</button>`;
        row.querySelector('button').onclick = ()=>{
          groupMembers[currentGroupId] = getMembers().filter(mm=>mm.id!==m.id);
          saveMembers(); renderMembersInModal(); renderExpenseShare();
        };
        existingMembersWrap.appendChild(row);
      });
    }

    function openAddExpense(){
      exTitle.value=''; exAmount.value=''; splitType='equal';
      exMembersList.innerHTML=''; exPaidBy.innerHTML='';
      getMembers().forEach(m=>{
        const opt = document.createElement('option'); opt.value=m.id; opt.textContent=m.name; exPaidBy.appendChild(opt);
        const row = document.createElement('div');
        row.className='flex items-center justify-between p-2 border rounded';
        row.innerHTML = `<div class="text-sm">${m.name}</div>
          <div class="flex items-center gap-2">
            <input type="number" step="0.01" class="share-field p-2 w-28 border rounded hidden" data-id="${m.id}" placeholder="value"/>
          </div>`;
        exMembersList.appendChild(row);
      });
      updateSplitFieldsVisibility();
      openModal(addExpenseModal);
    }
    function closeAddExpense(){ closeModal(addExpenseModal); }
    addExpenseQuick.onclick = (e)=>{ e.preventDefault(); openAddExpense(); };
    $('#cancel-add-expense').onclick = closeAddExpense;

    $$('.split-type').forEach(btn=>{
      btn.onclick = ()=>{
        $$('.split-type').forEach(b=>b.classList.remove('bg-indigo-600','text-white'));
        btn.classList.add('bg-indigo-600','text-white');
        splitType = btn.dataset.type; updateSplitFieldsVisibility();
      };
    });
    function updateSplitFieldsVisibility(){
      exMembersList.querySelectorAll('.share-field').forEach(inp=>{
        if(splitType==='equal') inp.classList.add('hidden'); else inp.classList.remove('hidden');
        inp.placeholder = splitType==='shares' ? 'shares' : splitType==='percent' ? '%' : 'amount';
      });
    }
    function computeSplitMap(amount){
      const ids = getMembers().map(m=>m.id);
      const map = {};
      if(splitType==='equal'){
        const share = amount/Math.max(1,ids.length);
        ids.forEach(id=> map[id] = +share.toFixed(2));
      }else{
        const fields = [...exMembersList.querySelectorAll('.share-field')];
        if(splitType==='shares'){
          const totalShares = fields.reduce((a,f)=>a+(+f.value||0),0) || 1;
          fields.forEach(f=> map[f.dataset.id] = +(amount*(+f.value||0)/totalShares).toFixed(2));
        }else if(splitType==='percent'){
          let totalP = fields.reduce((a,f)=>a+(+f.value||0),0); if(totalP<=0) totalP=100;
          fields.forEach(f=> map[f.dataset.id] = +(amount*((+f.value||0)/totalP)).toFixed(2));
        }else{
          fields.forEach(f=> map[f.dataset.id] = +(+f.value||0).toFixed(2));
          const sum = Object.values(map).reduce((a,v)=>a+v,0);
          if(sum>0 && Math.abs(sum-amount)>0.01){
            const factor = amount/sum;
            Object.keys(map).forEach(id=> map[id] = +(map[id]*factor).toFixed(2));
          }
        }
      }
      return map;
    }
    $('#confirm-add-expense').onclick = ()=>{
      const title = exTitle.value.trim();
      const amount = +(+exAmount.value||0).toFixed(2);
      const paidBy = exPaidBy.value;
      if(!title || amount<=0 || !paidBy) return alert('Fill title, amount and payer.');
      const splitMap = computeSplitMap(amount);
      const ex = { id:uid(), title, amount, paidBy, splitType, splitMap, date:nowISO(), settled:false };
      groupExpenses[currentGroupId].unshift(ex);
      saveExpenses();
      // Wallet ‚Äî log as Group
      wallet.byCategory['Group'] = (wallet.byCategory['Group']||0) + amount;
      wallet.tx.unshift({label:`Group: ${title}`, amount:-amount, date:ex.date, icon:'fa-users'});
      writeLS(LS.wallet,wallet);
      closeAddExpense(); renderExpenseShare(); renderWallet(); updateInsights();
    };

    function balances(){
      const bal = {}; getMembers().forEach(m=> bal[m.id]=0);
      getExpenses().forEach(e=>{
        bal[e.paidBy] += e.amount;
        Object.entries(e.splitMap).forEach(([id,val])=> bal[id] -= val);
      });
      return bal;
    }
    function settlementsFromBalances(bal){
      const debtors = [], creditors=[];
      Object.entries(bal).forEach(([id,v])=>{
        if(Math.abs(v)<0.01) return;
        if(v<0) debtors.push({id,amt:-v});
        else creditors.push({id,amt:v});
      });
      const res=[]; let i=0,j=0;
      while(i<debtors.length && j<creditors.length){
        const d = debtors[i], c = creditors[j];
        const pay = Math.min(d.amt, c.amt);
        res.push({from:d.id, to:c.id, amount:+pay.toFixed(2), paid:false, ts:null});
        d.amt-=pay; c.amt-=pay;
        if(d.amt<0.01) i++;
        if(c.amt<0.01) j++;
      }
      return res;
    }
    function renderExpenseShare(){
      populateGroupSelect();
      const members = getMembers();
      const expenses = getExpenses();

      groupMembersCount.textContent = members.length;
      groupExpensesCount.textContent = expenses.length;
      const total = expenses.reduce((a,e)=>a+e.amount,0);
      groupTotalSpent.textContent = `$${fmt(total)}`;

      // Recent
      recentExpensesList.innerHTML='';
      if(expenses.length===0){ show(noRecentExpenses); } else { hide(noRecentExpenses); }
      expenses.slice(0,10).forEach(e=>{
        const payer = members.find(m=>m.id===e.paidBy)?.name || 'Unknown';
        const row = document.createElement('div');
        row.className='flex items-center justify-between p-3 bg-white border rounded';
        row.innerHTML = `<div><p class="text-sm font-medium">${e.title}</p><p class="text-xs text-gray-500">${payer} ‚Ä¢ ${new Date(e.date).toLocaleString()}</p></div>
        <div class="text-sm font-bold text-gray-800">$${fmt(e.amount)}</div>`;
        recentExpensesList.appendChild(row);
      });

      // Balances
      const bal = balances();
      netBalancesWrap.innerHTML='';
      let any=false;
      Object.entries(bal).forEach(([id,v])=>{
        const m = members.find(mm=>mm.id===id);
        if(!m) return;
        const line = document.createElement('div');
        line.className='flex items-center justify-between p-2 bg-gray-50 rounded';
        const color = v>0?'text-green-700': v<0?'text-red-700':'text-gray-600';
        line.innerHTML = `<span class="text-sm">${m.name}</span><span class="text-sm font-bold ${color}">${v>0?'+':''}$${fmt(Math.abs(v))}${v>0?' (gets)':''}${v<0?' (owes)':''}</span>`;
        netBalancesWrap.appendChild(line);
        if(Math.abs(v)>=0.01) any=true;
      });
      noBalances.classList.toggle('hidden', any);

      // Settlements
      const setts = settlementsFromBalances(bal);
      settlementsWrap.innerHTML='';
      if(setts.length===0){ show(noSettlements); }
      else{
        hide(noSettlements);
        setts.forEach(s=>{
          const from = members.find(m=>m.id===s.from)?.name||'From';
          const to = members.find(m=>m.id===s.to)?.name||'To';
          const row = document.createElement('div');
          row.className='flex items-center justify-between p-2 bg-white border rounded';
          row.innerHTML = `<div class="text-sm"><b>${from}</b> ‚Üí <b>${to}</b></div>
                           <div class="flex items-center gap-2">
                             <div class="text-sm font-bold text-indigo-700">$${fmt(s.amount)}</div>
                             <button class="px-2 py-1 text-xs rounded bg-green-50 text-green-700 mark-paid">${s.paid?'Paid':'Mark Paid'}</button>
                           </div>`;
          row.querySelector('.mark-paid').onclick = ()=>{
            row.querySelector('.mark-paid').textContent='Paid';
            row.querySelector('.mark-paid').disabled = true;
          };
          settlementsWrap.appendChild(row);
        });
      }

      // Highlights
      const byMemberSpend = {};
      expenses.forEach(e=>{ byMemberSpend[e.paidBy]=(byMemberSpend[e.paidBy]||0)+e.amount; });
      let top = null, minDebt=null;
      Object.entries(bal).forEach(([id,v])=>{
        if(top===null || (byMemberSpend[id]||0)>(byMemberSpend[top]||0)) top=id;
        if((v<0) && (minDebt===null || v>minDebt)) minDebt=v;
      });
      const topName = members.find(m=>m.id===top)?.name || '‚Äî';
      const minDebtName = minDebt!==null ? members.find(m=>bal[m.id]===minDebt)?.name : '‚Äî';
      expHighlights.textContent = expenses.length
        ? `Top spender: ${topName}. Lowest debt: ${minDebtName || '‚Äî'}.`
        : 'Add a few expenses to see highlights.';

      // Member Contribution Chart
      const labels = members.map(m=>m.name);
      const values = members.map(m=> +(byMemberSpend[m.id]||0).toFixed(2));
      const ctx = document.getElementById('exp-group-chart');
      if(!window._expChart){
        window._expChart = new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data:values}]}, options:{plugins:{legend:{display:true}}}});
      }else{
        window._expChart.data.labels = labels;
        window._expChart.data.datasets[0].data = values;
        window._expChart.update();
      }
    }
    expenseShareBtn.onclick = ()=>{ expenseShareOverlay.classList.add('active'); renderExpenseShare(); };
    expenseShareBackBtn.onclick = ()=> expenseShareOverlay.classList.remove('active');
    btnExpExport.onclick = ()=>{
      const div = document.createElement('div');
      const members = getMembers(), expenses=getExpenses();
      const total = expenses.reduce((a,e)=>a+e.amount,0);
      div.innerHTML = `
        <h2 style="font-weight:800;font-size:18px">ExpenseShare Summary</h2>
        <p>Group: ${groups.find(g=>g.id===currentGroupId)?.name}</p>
        <p>Date: ${new Date().toLocaleString()}</p><hr/>
        <p>Members: ${members.map(m=>m.name).join(', ')||'‚Äî'}</p>
        <p>Total Spent: $${fmt(total)}</p>
        <h3>Expenses</h3>
        <ul>${expenses.slice(0,50).map(e=>`<li>${e.title}: $${fmt(e.amount)} (by ${members.find(m=>m.id===e.paidBy)?.name||'?'})</li>`).join('')||'<i>No expenses</i>'}</ul>
      `;
      html2pdf().from(div).set({filename:`expenseshare-${Date.now()}.pdf`}).save();
    };

    /*************** Search ***************/
    searchToggleBtn.onclick = ()=>{
      searchInput.classList.toggle('hidden');
      if(!searchInput.classList.contains('hidden')) searchInput.focus();
    };
    searchInput.oninput = ()=>{
      const q = searchInput.value.toLowerCase();
      [...cartList.children].forEach(li=>{
        const name = li.querySelector('.item-name').textContent.toLowerCase();
        li.style.display = name.includes(q)?'':'none';
      });
      [...historyList.children].forEach(li=>{
        const name = li.querySelector('.item-name').textContent.toLowerCase();
        li.style.display = name.includes(q)?'':'none';
      });
    };

    /*************** Chatbot ‚Äî Smart Actions ***************/
    function pushBot(text){
      const wrap = document.createElement('div'); wrap.className='flex';
      const b = document.createElement('div'); b.className='bubble bot'; b.textContent = text;
      wrap.appendChild(b); chatbotMessages.appendChild(wrap); chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }
    function pushMe(text){
      const wrap = document.createElement('div'); wrap.className='flex justify-end';
      const b = document.createElement('div'); b.className='bubble me'; b.textContent = text;
      wrap.appendChild(b); chatbotMessages.appendChild(wrap); chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }
    chatbotFab.onclick = ()=>{ chatbotOverlay.style.display='flex'; };
    chatbotClose.onclick = ()=>{ chatbotOverlay.style.display='none'; };
    chatbotClear.onclick = ()=>{ chatbotMessages.innerHTML=''; };

    chatbotForm.addEventListener('submit',(e)=>{
      e.preventDefault();
      const msg = chatbotInput.value.trim(); if(!msg) return;
      pushMe(msg); chatbotInput.value='';
      chatbotTyping.classList.remove('hidden');
      setTimeout(()=>{ chatbotTyping.classList.add('hidden'); handleChat(msg.toLowerCase()); }, 350);
    });

    function handleChat(m){
      // Cart add
      if(m.startsWith('add ') && m.includes(' to cart')){
        const name = m.replace('add','').replace('to cart','').trim();
        if(name){ cart.push(name); writeLS(LS.cart,cart); renderCart(); pushBot(`Added "${name}" to cart.`); return; }
      }
      // Last N expenses
      if(m.match(/last\s+\d+\s+expenses/) || m.includes('last 5 expenses')){
        const n = Number((m.match(/last\s+(\d+)/)||[])[1]||5);
        const out = historyItems.slice(0,n).map(h=>`${h.name} @ ${h.store} $${fmt(h.total)}`).join(' ‚Ä¢ ') || 'No expenses yet.';
        pushBot(out); return;
      }
      // Category spend
      if(m.includes('how much') && m.includes('on')){
        const cat = (m.split('on')[1]||'').trim();
        const spent = (wallet.byCategory[cat]||0);
        pushBot(`You spent $${fmt(spent)} on ${cat}.`); return;
      }
      // Wallet add
      if(m.startsWith('add ‚Ç©') || m.startsWith('add $') || m.startsWith('add ')){
        const num = Number(m.replace(/[^\d.]/g,''));
        if(num>0){ wallet.balance += num; wallet.tx.unshift({label:'Wallet top-up', amount:num, date:nowISO(), icon:'fa-wallet'}); writeLS(LS.wallet,wallet); renderWallet(); pushBot(`Added $${fmt(num)} to wallet.`); return; }
      }
      // Who owes me (ExpenseShare)
      if(m.includes('who owes') || m.includes('who owes me')){
        const bal = balances();
        const members = getMembers();
        const debtors = Object.entries(bal).filter(([_,v])=>v<0).map(([id,v])=>`${members.find(m=>m.id===id)?.name}: $${fmt(-v)}`);
        pushBot(debtors.length? `Owe you ‚Üí ${debtors.join(' ‚Ä¢ ')}` : 'No one owes you right now.'); return;
      }
      // Goals progress
      if(m.includes('goal') || m.includes('progress on')){
        const out = goals.map(g=>`${g.title}: $${fmt(g.saved)}/$${fmt(g.target)}`).join(' ‚Ä¢ ') || 'No goals yet.';
        pushBot(out); return;
      }
      // Export all
      if(m.includes('export all') || m.includes('download all')){
        menuExportAll.click(); pushBot('Exported all data to PDF.'); return;
      }
      // Open overlays
      if(m.includes('open wallet')){ moneyOverlay.classList.add('active'); renderWallet(); pushBot('Opening wallet‚Ä¶'); return; }
      if(m.includes('open expense') || m.includes('show settlements')){ expenseShareOverlay.classList.add('active'); renderExpenseShare(); pushBot('Opening ExpenseShare‚Ä¶'); return; }

      pushBot('I can add to cart, show last expenses, report category totals, update wallet, show who owes you, show goals, export data, and open Wallet/ExpenseShare.');
    }

    /*************** Tiles ***************/
    tileExpenseShare.onclick = ()=>{ expenseShareOverlay.classList.add('active'); renderExpenseShare(); };
    tileWallet.onclick = ()=>{ showSection('history'); moneyOverlay.classList.add('active'); renderWallet(); };
    tileJournal.onclick = ()=> alert('Journal module coming later (placeholder).');
    tileTodo.onclick = ()=> alert('To-Do module coming later (placeholder).');

    /*************** Persist & Init ***************/
    function persistAll(){
      writeLS(LS.cart, cart); writeLS(LS.history, historyItems); writeLS(LS.stores, stores);
      writeLS(LS.profile, profile); writeLS(LS.wallet, wallet);
      writeLS(LS.expGroups, groups); writeLS(LS.expMembers, groupMembers); writeLS(LS.expExpenses, groupExpenses);
      writeLS(LS.goals, goals); writeLS(LS.recurring, recurring); writeLS(LS.theme, theme);
    }

    function renderAll(){
      applyProfile();
      renderCart();
      renderHistory();
      renderWallet();
      renderGoals();
      renderRecurring();
      computeTodayVsAverage();
      setDailyTip();
      applyTheme();
    }

    function init(){
      // FAB initial visibility
      showSection('dashboard');
      renderAll();

      // Chatbot & Wallet FABs also via nav:
      // (Visibility toggled in showSection)
    }
    init();
  </script>
</body>
</html>
